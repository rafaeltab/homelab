# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: loki
#   namespace: observability
# spec:
#   interval: 5m
#   chart:
#     spec:
#       chart: loki
#       version: "6.41.1"
#       sourceRef:
#         kind: HelmRepository
#         name: grafana
#         namespace: flux-system
#       interval: 1h
#   install:
#     remediation:
#       retries: 3
#   upgrade:
#     remediation:
#       retries: 3
#   values:
#     # Run Loki in microservices (Distributed) mode
#     deploymentMode: Distributed
#
#     # Use your existing MinIO; do not deploy the chart's demo MinIO
#     minio:
#       enabled: false
#
#     # Only expose in-cluster
#     gateway:
#       enabled: true
#       service:
#         type: ClusterIP
#
#     # Loki configuration (kept minimal and adjustable later)
#     loki:
#       auth_enabled: false
#       schemaConfig:
#         configs:
#           - from: "2024-04-01"
#             store: tsdb
#             object_store: s3
#             schema: v13
#             index:
#               prefix: loki_index_
#               period: 24h
#       limits_config:
#         allow_structured_metadata: true
#         volume_enabled: true
#         retention_period: 672h # 28 days
#
#       # Storage convenience block (chart will render storage_config for Loki)
#       storage:
#         type: s3
#         bucketNames:
#           chunks: loki-chunks
#           ruler: loki-ruler
#         s3:
#           # Use env expansion for credentials; see extraArgs and envFrom below
#           accessKeyId: ${access_key}
#           secretAccessKey: ${secret_key}
#           endpoint: http://minio.minio.svc.cluster.local:80
#           s3ForcePathStyle: true
#           insecure: true
#           # region/signatureVersion are not required for MinIO; omit
#
#     # Replicas as per the tutorial defaults
#     distributor:
#       replicas: 1
#       maxUnavailable: 0
#       affinity: {}
#       topologySpreadConstraints: []
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     ingester:
#       replicas: 1
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     querier:
#       replicas: 1
#       maxUnavailable: 0
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     queryFrontend:
#       replicas: 1
#       maxUnavailable: 0
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     queryScheduler:
#       replicas: 1
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     compactor:
#       replicas: 1
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     indexGateway:
#       replicas: 1
#       maxUnavailable: 0
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#     ruler:
#       # Deployed by default; inherits storage via loki.storage and needs creds
#       extraArgs:
#         - "-config.expand-env=true"
#       extraEnvFrom:
#         - secretRef:
#             name: loki-minio-user
#
#     # Disable unused optional bloom components
#     bloomPlanner:
#       replicas: 0
#     bloomBuilder:
#       replicas: 0
#     bloomGateway:
#       replicas: 0
#
#     # Not used in Distributed mode here
#     backend:
#       replicas: 0
#     read:
#       replicas: 0
#     write:
#       replicas: 0
#     singleBinary:
#       replicas: 0
